<ng-container *transloco="let t; scope: 'scalper-order-book/scalper-order-book-table'">
  @if (dataContext().extendedSettings$ | async; as settings) {
    @if (settings.widgetSettings.showRuler) {
      <div class="position-absolute start">
        <ats-table-ruler [activeRow]="hoveredRow$ | async"
          [dataContext]="dataContext()"
          [xAxisStep]="rowHeight()"
           />
      </div>
    }
    @if (displayItems$ | async; as displayItems) {
      <div
        [atsHoverItemsGroup]="true"
        (hoveredItemChanged)="updateHoveredItem($event?.item?.atsHoverItemData() ?? null)"
        id="table-body-container"
        class="user-select-none"
        >
        <div class="table-col" id="volume-panel">
          @for (row of displayItems; track $index) {
            <div (mousedown)="mouseDown($event, row)"
              (contextmenu)="$event.preventDefault()"
              [style.height]="rowHeight() + 'px'"
              [style.line-height]="rowHeight() + 'px'"
              class="table-row"
              [class.hovered]="(hoveredRow$ | async)?.price === row.price"
              atsHoverItem
              [atsHoverItemData]="{price: row.price}"
              >
              <div [ngClass]="getVolumeCellClasses(row)"
                class="table-cell"
                >
                @if (row.isMajorLinePrice || row.isMinorLinePrice) {
                  <span
                    class="z-1"
            [ngClass]="{
            'grid-line': true,
            'major': row.isMajorLinePrice,
            'minor': row.isMinorLinePrice
            }"
                  >&nbsp;</span>
                }
                @if ((row.volume ?? 0) > 0) {
                  <span class="highlighter z-1" [ngStyle]="row.getVolumeStyle()">&nbsp;</span>
                  <span class="volume px-2 z-2">
                    @if (row.rowType === rowTypes.Mixed) {
                      <span [ngTemplateOutlet]="volumeDisplay" [ngTemplateOutletContext]="{volume: row.askVolume ?? 0}"></span>
                      <span>&nbsp;|&nbsp;</span>
                      <span [ngTemplateOutlet]="volumeDisplay" [ngTemplateOutletContext]="{volume: row.bidVolume ?? 0}"></span>
                    } @else {
                      @if (showGrowingVolume && (row.growingVolume ?? 0) > 0) {
                        <span class="growing-volume">
                          <ng-container [ngTemplateOutlet]="volumeDisplay" [ngTemplateOutletContext]="{volume: row.growingVolume}" />
                        </span>
                      }
                      <ng-container [ngTemplateOutlet]="volumeDisplay" [ngTemplateOutletContext]="{volume: row.volume}" />
                    }
                  </span>
                  <ng-template #volumeDisplay let-volume='volume'>
                    @if (settings.widgetSettings.volumeDisplayFormat === numberFormats.LetterSuffix) {
                      <ats-short-number [value]="volume"
                        [allowRounding]="true"
                       />
                    } @else {
                      <span>{{volume}}</span>
                    }
                  </ng-template>
                }
              </div>
            </div>
          }
        </div>
        <div class="table-col" id="price-panel">
          @for (row of displayItems; track $index) {
            <div (mousedown)="mouseDown($event, row)"
              (contextmenu)="$event.preventDefault()"
              (dblclick)="$event.stopPropagation()"
              [style.height]="rowHeight() + 'px'"
              [style.line-height]="rowHeight() + 'px'"
              class="table-row"
              [class.hovered]="(hoveredRow$ | async)?.price === row.price"
              atsHoverItem
              [atsHoverItemData]="{price: row.price}"
              >
              <div
                [ngClass]="getPriceCellClasses(row)"
                class="table-cell"
                >
                @if (row.isMajorLinePrice || row.isMinorLinePrice) {
                  <span
                    class="z-1"
            [ngClass]="{
            'grid-line': true,
            'major': row.isMajorLinePrice,
            'minor': row.isMinorLinePrice
            }"
                  >&nbsp;</span>
                }
                @if (row.currentOrders.length > 0) {
                  <span class="highlighter">&nbsp;</span>
                }
                <span
                  class="px-2 position-relative z-2"
                  [class.fw-bold]="row.isMajorLinePrice"
                  >
                  {{row.price | atsPrice: getPriceDecimalSymbolsCount(settings)}}
                </span>
              </div>
            </div>
          }
        </div>
        <div class="table-col orders-drag-boundary" id="orders-panel" cdkDropListGroup>
          @for (row of displayItems; track $index) {
            <div (dblclick)="$event.stopPropagation()"
              (contextmenu)="$event.preventDefault()"
              [style.height]="rowHeight() + 'px'"
              [style.line-height]="rowHeight() + 'px'"
              class="table-row"
              [class.hovered]="(hoveredRow$ | async)?.price === row.price"
              atsHoverItem
              [atsHoverItemData]="{price: row.price}"
              >
              <div
                [ngClass]="getOrdersCellClasses(row)"
                class="table-cell"
                cdkDropList
                [cdkDropListAutoScrollDisabled]="true"
                (cdkDropListDropped)="updateOrderPrice($event.item.data, row)"
                >
                @if (row.isMajorLinePrice || row.isMinorLinePrice) {
                  <span
                    class="z-1"
            [ngClass]="{
            'grid-line': true,
            'major': row.isMajorLinePrice,
            'minor': row.isMinorLinePrice
            }"
                  >&nbsp;</span>
                }
                <ng-container *ngTemplateOutlet="limitOrdersDisplay; context: {
            orders:  getFilteredOrders(row.currentOrders, orderTypes.Limit)
            }"
                   />
                <ng-container *ngTemplateOutlet="stopOrdersDisplay; context: {
            orders:  getFilteredOrders(row.currentOrders, orderTypes.StopLimit),
            orderSymbol: 'SL',
            tooltipKey: 'stopLimitOrderTooltip'
            }" />
                <ng-container *ngTemplateOutlet="stopOrdersDisplay; context: {
            orders:  getFilteredOrders(row.currentOrders, orderTypes.StopMarket),
            orderSymbol: 'SM',
            tooltipKey: 'stopMarketOrderTooltip'
            }" />
                <ng-template #limitOrdersDisplay let-orders="orders">
                  @if (orders.volume > 0) {
                    <span (click)="cancelOrders($event, orders.orders)"
                      (mousedown)="$event.stopPropagation()"
                      class="orders-indicator limit-order fw-bold px-1 position-relative z-2"
                      *ngrxLet="hasDirtyOrders(orders.orders) as isDirty"
                    [ngClass]="{
                    'bid': isAllOrdersHaveSide(orders.orders, ordersSides.Buy),
                    'ask': isAllOrdersHaveSide(orders.orders, ordersSides.Sell),
                    'multiple': orders.orders.length > 1,
                    'dirty': isDirty
                    }"
                      [nz-tooltip]="hideTooltips() ? null : t('scalperOrderBookScalperOrderBookTable.limitOrderTooltip')"
                      [nzTooltipMouseEnterDelay]="1"
                      [nzTooltipPlacement]="['right', 'left']"
                      [nzTooltipTrigger]="isDirty ? null : 'hover'"
                      cdkDrag
                      [cdkDragData]="orders.orders"
                      [cdkDragDisabled]="isDirty"
                      cdkDragBoundary=".orders-drag-boundary"
                    >{{orders.volume}}</span>
                  }
                </ng-template>
                <ng-template #stopOrdersDisplay let-orderSymbol="orderSymbol" let-orders="orders" let-tooltipKey="tooltipKey">
                  @if (orders.volume > 0) {
                    <span (click)="cancelOrders($event, orders.orders)"
                      (mousedown)="$event.stopPropagation()"
                      class="orders-indicator pl-2 position-relative z-2"
                      *ngrxLet="hasDirtyOrders(orders.orders) as isDirty"
                    [ngClass]="{
                    'bid': isAllOrdersHaveSide(orders.orders, ordersSides.Buy),
                    'ask': isAllOrdersHaveSide(orders.orders, ordersSides.Sell),
                    'multiple': orders.orders.length > 1,
                    'dirty': isDirty
                    }"
                      [nz-tooltip]="hideTooltips() ? null : t('scalperOrderBookScalperOrderBookTable.' + tooltipKey)"
                      [nzTooltipMouseEnterDelay]="1"
                      [nzTooltipPlacement]="['right', 'left']"
                      [nzTooltipTrigger]="isDirty ? null : 'hover'"
                      cdkDrag
                      [cdkDragData]="orders.orders"
                      [cdkDragDisabled]="isDirty"
                      cdkDragBoundary=".orders-drag-boundary"
                    >{{orderSymbol}}({{orders.volume}})</span>
                  }
                </ng-template>
              </div>
            </div>
          }
        </div>
      </div>
    }
  }
</ng-container>

